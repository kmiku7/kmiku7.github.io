<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kmiku7&#39;s blog</title>
  
    <meta name="robots" content="noindex, follow">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="kmiku7&#39;s blog">
<meta property="og:url" content="http://kmiku7.github.io/page/3/index.html">
<meta property="og:site_name" content="kmiku7&#39;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kmiku7&#39;s blog">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  <!--link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"-->
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-27155459-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">kmiku7&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">JUST DO IT.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://kmiku7.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-difference-between-manage-py-runserver-and-uswgi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/07/difference-between-manage-py-runserver-and-uswgi/" class="article-date">
  <time datetime="2018-02-07T07:03:05.000Z" itemprop="datePublished">Feb 7 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/07/difference-between-manage-py-runserver-and-uswgi/">difference between &#39;manage.py runserver&#39; and uswgi</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="python-manage-py-runserver-启动方式"><a href="#python-manage-py-runserver-启动方式" class="headerlink" title="python manage.py runserver 启动方式"></a>python manage.py runserver 启动方式</h3><p>该命令执行的 django/core/management/commands/runserver.py 中的代码，通过调用链：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">execute()</span><br><span class="line">    -&gt; BaseCommand::execute()</span><br><span class="line">    -&gt; handle() </span><br><span class="line">    -&gt; run() </span><br><span class="line">    -&gt; inner_run() </span><br><span class="line">    -&gt; get_handler() </span><br><span class="line">    -&gt; django.core.servers.basehttp.get_internal_wsgi_application()</span><br></pre></td></tr></table></figure></p>
<p>获取一个 WSGI application object。</p>
<p>get_internal_wsgi_application() 默认调用 django.core.wsgi.get_wsgi_application()，该函数首先读取settings.WSGI_APPLICATION参数获取一个wsgi application object对象。</p>
<p>WSGI_APPLICATION参数设置方式参考：</p>
<blockquote>
<p>By default, it’s set to <project_name>.wsgi.application, which points to the application callable in <project_name>/wsgi.py.</project_name></project_name></p>
</blockquote>
<p>如果该参数没有设置，则调用 <strong>django.core.wsgi.get_wsgi_application()</strong>，返回django.core.handers.wsgi.WSGIHandler类的实例。</p>
<h3 id="使用uwsgi启动"><a href="#使用uwsgi启动" class="headerlink" title="使用uwsgi启动"></a>使用uwsgi启动</h3><p>当使用 django-admin startproject ProjectName 创建新app后，会生成 ProjectName/wsgi.py 文件，该文件默认也使用 <strong>django.core.wsgi.get_wsgi_application()</strong> 获取一个application object。 </p>
<p>refference:<br><a href="http://uwsgi-docs.readthedocs.io/en/latest/Python.html" target="_blank" rel="noopener">http://uwsgi-docs.readthedocs.io/en/latest/Python.html</a></p>
<p>因此二者默认情况下是一样的。但是个性化配置方式不同。</p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/02/07/difference-between-manage-py-runserver-and-uswgi/" data-id="cjonvdpbw000l6wfymswkngt0" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/02/07/difference-between-manage-py-runserver-and-uswgi/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Django/">Django</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uWSGI/">uWSGI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zh/">zh</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solve-the-problem-of-uwsgi-uwsgi-response-write-body-do-TIMEOUT-error" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/02/Solve-the-problem-of-uwsgi-uwsgi-response-write-body-do-TIMEOUT-error/" class="article-date">
  <time datetime="2018-02-02T04:05:15.000Z" itemprop="datePublished">Feb 2 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/02/Solve-the-problem-of-uwsgi-uwsgi-response-write-body-do-TIMEOUT-error/">Solve  &#39;uwsgi_response_write_body_do() TIMEOUT !!!&#39; error</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I write a django service to produce very large data in response, about 10GB data per request or even larger sometimes.</p>
<p>When I use <code>python manage.py runserver</code> to test service, there is no problem. But when use nginx + uwsgi to support service, I can&#39;t get the complete response at the client side. At the same time, there is an error log in uwsgi.log and a regular log notice that uswgi has finished request processing:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Fri Feb  88 88:88:88 2088 - uwsgi_response_write_body_do() TIMEOUT !!!</span><br><span class="line">OSError: write error</span><br><span class="line">GET REQUEST-URL =&gt; generated 8888888888 bytes in 8888 msecs (HTTP/1.1 200) 8 headers in 888 bytes</span><br></pre></td></tr></table></figure></p>
<p>When uwsgi outputs these logs, the client still receives response data until the size of received equal to the generated size output in server log. And the generated size is smaller than the full size of response. So I think there is a large buffer in Nginx. Uwsgi writes response to Nginx actively and the speed is very fast because they are in same machine. But Nginx writes response to client is slow. If Nginx stores response data in buffer, uwsgi&#39;s write request will block when buffer is full. If buffer size is very large, uwsgi will wait a long time before Nginx clears its buffer and write request timeout.<br>Only in this way the Nginx can still write data to client when uwsgi finishs processing and close response stream.</p>
<p>According to <a href="http://nginx.org/en/docs/http/ngx_http_uwsgi_module.html#uwsgi_buffering" target="_blank" rel="noopener">ngx_http_uwsgi_module&#39;s document</a>:</p>
<blockquote>
<p>When buffering is enabled, nginx receives a response from the uwsgi server as soon as possible, saving it into the buffers set by the uwsgi_buffer_size and uwsgi_buffers directives. If the whole response does not fit into memory, a part of it can be saved to a temporary file on the disk. Writing to temporary files is controlled by the uwsgi_max_temp_file_size and uwsgi_temp_file_write_size directives.</p>
</blockquote>
<p>There are memory buffers and temporary file buffers. The default size of memory buffers is only a few kilobytes. But the default max size of temporary file buffers is 1024MB, which is approximately equal to the generated size in uwsgi log.</p>
<p><strong>In order to solve this problem, we can just disable temporary file buffers, use the directive <code>uwsgi_max_temp_file_size 0;</code>. </strong></p>
<p>A memory buffer of a few kilobytes is ok because it will not block uwsgi&#39; write request much time.<br>But as the previous analysis, if the transmission speed between Nginx and client side is far slower to the speed between Nginx and uswgi, the problem will come up no matter how smaller the buffer is.<br>As the implementation of Django and uwsgi, uwsgi read a block of data and write to response stream, if the block size is large enough and the transmission speed to the client side is slow enough, the problem will come up even all buffers in Nginx disabled. Because the block can be considered as a different form of buffer.</p>
<p>So slower transmission speed to client side means the smaller size of buffer we can use.<br>And we don&#39;t know user&#39;s network conditions, what we can do is only disable buffers.</p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/02/02/Solve-the-problem-of-uwsgi-uwsgi-response-write-body-do-TIMEOUT-error/" data-id="cjonvdpb800066wfy69ul7ojl" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/02/02/Solve-the-problem-of-uwsgi-uwsgi-response-write-body-do-TIMEOUT-error/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/debug/">debug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/en/">en</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uWSGI/">uWSGI</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-codis-network-archi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/14/codis-network-archi/" class="article-date">
  <time datetime="2015-08-14T13:07:59.000Z" itemprop="datePublished">Aug 14 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/database/">database</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/14/codis-network-archi/">Codis请求转发流程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文是的一篇 Codis 代码阅读笔记，涉及的是 codis-proxy 从接收 client 请求，转发给 redis(codis-server)，然后返回给 client 的过程。Codis 代码开始阅读的是重构后的2.0版本，流程比较清晰高效，后来需要了解公司对 Codis 的使用修改情况，而线上系统是基于1.8的，这个版本的请求解析转发流程则有点晦涩，所以把分析结果记录下来，也作为 golang-server 开发的一个参考。  </p>
<p>codis-config 在1.8/2.0版本之间接口、代码结构变化很少，zk角色功能变化较多，这部分不在本文范围之内。</p>
<p>这幅图是解析转发请求的顺序图（请不要在意细节）：<br><img src="/img/codis-1_8-network-pattern.png" alt="" title="codis-1_8-network-pattern.png"><br>其中以Chan结尾的代表结构体里的channel或list，其他为结构体里实现的函数，通过goroutine运行，其中：</p>
<ul>
<li>redisTunnel &amp; WritingLoop 分别负责一个client连接的读写两端，redisTunnel函数实现在Server类里；  </li>
<li>TaskRunner与一个redis实例一一对应，因此proxy内对同一个redis的请求是串行的；</li>
<li>Server代表当前运行的Proxy实例。</li>
</ul>
<p>在这个架构里：</p>
<ol>
<li>session类对应client实体，每个client有一对 read-routine &amp; write-routine 处理 client 的读请求和返回请求，客户端请求和命令结果分别对应的结构体是PipelineRequest &amp; PipelineResponse；  </li>
<li>请求 PipelineRequest 在 Server::reqCh 里串行化了，由一个唯一的 Server::handleTopoEvent-routine 分发(dispatch)给不同的后端 redis(TaskRunner)。</li>
<li>每个后端 redis 对应一个 TaskRunner，有两个routine： writeLoop &amp; readLoop。<br>writeLoop routine 从 chan-in 读取 PipelineRequest 然后通过 socket 写给后端，同时从 chan-out 读取 ParseResp 并封装成 PipelineResponse  发送给 Session::backQ。<br>readLoop routine 从 socket 读取解析数据封装成 ParseResp 然后插入到 chan-out。</li>
<li>这里面 dispatch 分发过程是串行的。</li>
<li>mget/mset/del 是串行执行的，不直接使用TaskRunner，而是新建一个独立的到本机服务的连接，转换成单key操作。并且是一个短链接，虽然代码里用到了pool object，但只是用来建立连接的。</li>
</ol>
<p>3.0与1.8的差别在于 session::loopReader (相当于1.8的 read-routine )在自己的 goroutine 里分派 Request object 到对应 Backend (对应1.8的 TaskRunner )的队列中，同时使用了 Future 模式，session::loopWriter 阻塞在对应的 Reqest::WaitGroup 上，Backend 处理完调用 Request::WaitGroup.done() 通知 loopWriter-routine 处理结束。去掉了串行 dispatch 这个瓶颈。  </p>
<p>我的注释版代码: <a href="https://github.com/kmiku7/codis-annotated" target="_blank" rel="noopener">github</a></p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2015/08/14/codis-network-archi/" data-id="cjonvdpbo000f6wfyi6bq3ou4" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2015/08/14/codis-network-archi/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-analysis/">code-analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/codis/">codis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/proxy/">proxy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zh/">zh</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-b-tree-implement" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/27/b-tree-implement/" class="article-date">
  <time datetime="2015-04-27T14:52:33.000Z" itemprop="datePublished">Apr 27 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/algorithm/">algorithm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/27/b-tree-implement/">B-Tree实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>依照CLRS讲解实现了一个B-Tree，包括create &amp; insert &amp; search &amp; delete操作，实现上使用迭代完成，没有使用递归。<br>CODE: <a href="https://github.com/kmiku7/algorithms/blob/20150427/b-tree/btree.h" target="_blank" rel="noopener">link</a>.  </p>
<p>B-Tree节点定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T           85</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BNODE_KEY_SIZE  (2*T-1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BNODE_CHILDREN_SIZE (2*T)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BTreeNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">    <span class="keyword">bool</span> is_leaf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> keys[BNODE_KEY_SIZE];</span><br><span class="line">    <span class="keyword">size_t</span> values[BNODE_KEY_SIZE];</span><br><span class="line">    <span class="keyword">size_t</span> children[BNODE_CHILDREN_SIZE];</span><br><span class="line"></span><br><span class="line">    BTreeNode() : count(<span class="number">0</span>), is_leaf(<span class="literal">true</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>字段具体含义不解释。每个BTreeNode对一个磁盘页，实现了一组sim_XXX()函数模拟磁盘数据载入写出过程，通常用户持有一个size_t类型的node id，使用sim_get_node(size_t node_id)函数载入对应的磁盘数据，并返回对应的内存地址，修改或访问完以后使用sim_release_node()释放并“写回磁盘”。目前这组函数里做的只是size_t和BTreeNode*类型间的转换，可以额外增加写cache、reference_count代码，模拟实际开销。  </p>
<p><a href="https://github.com/kmiku7/algorithms/blob/20150427/b-tree/btree.h#L122-L205" target="_blank" rel="noopener">b_tree_insert()</a> 实现可以检测重复key，如果重复则只是更新对应的value值。<br>该函数实现有一点需要注意：当关键字k插入到x节点时，对应的插入子树为c<sub>i</sub>[x]，如果n[c<sub>i</sub>[x]]==2t-1，则需要拆分子树c<sub>i</sub>[x]，拆分后k &amp; key<sub>i</sub>[x]的相对关系会变化，需要重新对比k &amp; key<sub>i</sub>[x] &amp; key<sub>i+1</sub>[x]三者间的关系：确定k是否重复，需要递归处理拆分出来的c<sub>i</sub>[x] &amp; c<sub>i+1</sub>[x]中的哪一个，对应在实现代码的 line: <a href="https://github.com/kmiku7/algorithms/blob/20150427/b-tree/btree.h#L153-L178" target="_blank" rel="noopener">153-178</a>。<br>这部分还可以不检测，split-child以后下次递归或循环还在当前节点处理而不下降，代码会清爽一些。  </p>
<p><a href="https://github.com/kmiku7/algorithms/blob/20150427/b-tree/btree.h#L322-L503" target="_blank" rel="noopener">b_tree_delete()</a> 实现复杂一些。按照CLRS描述，对于递归处理的下一节点x有：n[x]&gt;=t，因此x有可能会跟左兄弟或有兄弟合并，合并后n[parent[x]]会减一，如果parent[x]是根节点，则意味着合并后x再无兄弟节点，x成为新的根节点。这种情况在2c) &amp; 3b)里会出现，需要注意处理。  </p>
<p>剩下的可以直接看代码，有问题可以留言。</p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2015/04/27/b-tree-implement/" data-id="cjonvdpbr000j6wfy7gnbbi4r" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2015/04/27/b-tree-implement/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/b-tree/">b-tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clrs/">clrs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cpp/">cpp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-structure/">data-structure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tree/">tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zh/">zh</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-basic-aho-corasick-algorithm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/25/basic-aho-corasick-algorithm/" class="article-date">
  <time datetime="2015-04-25T13:19:50.000Z" itemprop="datePublished">Apr 25 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/algorithm/">algorithm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/25/basic-aho-corasick-algorithm/">AC-Search实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>写了一遍多字符串匹配的ac-search算法，输出所有的原串匹配区间。  </p>
<p>build_trie()构造一个trie，build_longest_trans_target()函数构造自动机无法前向匹配时的转移路径，即TrieNode::prefix字段。当自动机到达一个最终状态后(terminal state，TrieNode::pattern_end)构造原串当前位置之前的所有匹配区间，通过把patterns串reverse之后构造出一个prefix树然后遍历实现。如果有更好的匹配串构造方法请留言。  </p>
<p>原理请参考： &lt;Flexible Pattern Matching in Strings&gt;, 3.2.2 Basic Aho-Corasick Algorithm.</p>
<h4 id="Trie-amp-reverse-patterns-之后的trie树和状态机构造代码"><a href="#Trie-amp-reverse-patterns-之后的trie树和状态机构造代码" class="headerlink" title="Trie &amp; reverse(patterns)之后的trie树和状态机构造代码"></a>Trie &amp; reverse(patterns)之后的trie树和状态机构造代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TrieNode</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">TrieNode</span>* <span class="title">sibling</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">TrieNode</span>* <span class="title">children</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">TrieNode</span>* <span class="title">prefix</span>;</span></span><br><span class="line">    <span class="keyword">int</span> height; <span class="comment">// 1, 2, 3 ...</span></span><br><span class="line">    <span class="keyword">bool</span> pattern_end;</span><br><span class="line">    <span class="keyword">char</span> this_char;</span><br><span class="line">    TrieNode() : sibling(<span class="literal">nullptr</span>), children(<span class="literal">nullptr</span>), prefix(<span class="literal">nullptr</span>), </span><br><span class="line">            height(<span class="number">0</span>), pattern_end(<span class="literal">false</span>), this_char(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">TrieNode* <span class="title">get_node</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TrieNode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release_node</span><span class="params">(TrieNode* node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">delete</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_trie</span><span class="params">(TrieNode* root)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;TrieNode*&gt; <span class="built_in">stack</span>;</span><br><span class="line">    <span class="built_in">stack</span>.push_back(root);</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">stack</span>.empty())&#123;</span><br><span class="line">        root = <span class="built_in">stack</span>.back();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">stack</span>.pop_back();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">stack</span>.back() = root-&gt;sibling;</span><br><span class="line">        <span class="built_in">stack</span>.push_back(root-&gt;children);</span><br><span class="line">        release_node(root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// assumption: there are no duplicate item and no empty string in strs.</span></span><br><span class="line"><span class="function">TrieNode* <span class="title">build_trie</span><span class="params">(<span class="keyword">const</span> <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&amp; strs)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// build root;</span></span><br><span class="line">    TrieNode* root = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;str : strs) &#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        TrieNode** insert_pos = &amp;root;</span><br><span class="line">        TrieNode* parent_node = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> curr_char : str) &#123;</span><br><span class="line">            <span class="comment">// find insert pos</span></span><br><span class="line">            len += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(*insert_pos!=<span class="literal">nullptr</span> &amp;&amp; (*insert_pos)-&gt;this_char&lt;curr_char)</span><br><span class="line">                insert_pos = &amp;(*insert_pos)-&gt;sibling;</span><br><span class="line"></span><br><span class="line">            parent_node = *insert_pos;</span><br><span class="line">            <span class="comment">// new char, insert</span></span><br><span class="line">            <span class="keyword">if</span>(*insert_pos==<span class="literal">nullptr</span> || (*insert_pos)-&gt;this_char&gt;curr_char) &#123;</span><br><span class="line">                parent_node = get_node();</span><br><span class="line">                parent_node-&gt;sibling = *insert_pos;</span><br><span class="line">                parent_node-&gt;this_char = curr_char;</span><br><span class="line">                parent_node-&gt;height = len;</span><br><span class="line">                *insert_pos = parent_node;</span><br><span class="line">            &#125;</span><br><span class="line">            insert_pos = &amp;parent_node-&gt;children;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// no duplicate</span></span><br><span class="line">        assert(parent_node &amp;&amp; parent_node-&gt;pattern_end==<span class="literal">false</span>);</span><br><span class="line">        parent_node-&gt;pattern_end = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 忽略这个名字吧。。</span></span><br><span class="line"><span class="function">TrieNode* <span class="title">build_suffix</span><span class="params">(<span class="keyword">const</span> <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&amp; strs)</span> </span>&#123;</span><br><span class="line">    TrieNode* root = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;str : strs) &#123;</span><br><span class="line">        TrieNode** insert_pos = &amp;root;</span><br><span class="line">        TrieNode* parent_node = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;str.size(); ++i) &#123;</span><br><span class="line">            <span class="keyword">char</span> curr_char = str[str.size()<span class="number">-1</span>-i];</span><br><span class="line">            <span class="keyword">while</span>(*insert_pos!=<span class="literal">nullptr</span> &amp;&amp; (*insert_pos)-&gt;this_char&lt;curr_char)</span><br><span class="line">                insert_pos = &amp;(*insert_pos)-&gt;sibling;</span><br><span class="line"></span><br><span class="line">            parent_node = *insert_pos;</span><br><span class="line">            <span class="keyword">if</span>(*insert_pos==<span class="literal">nullptr</span> || (*insert_pos)-&gt;this_char&gt;curr_char) &#123;</span><br><span class="line">                parent_node = get_node();</span><br><span class="line">                parent_node-&gt;sibling = *insert_pos;</span><br><span class="line">                parent_node-&gt;this_char = curr_char;</span><br><span class="line">                parent_node-&gt;height = i+<span class="number">1</span>;</span><br><span class="line">                *insert_pos = parent_node;</span><br><span class="line">            &#125;</span><br><span class="line">            insert_pos = &amp;parent_node-&gt;children;</span><br><span class="line">        &#125;</span><br><span class="line">        assert(parent_node &amp;&amp; parent_node-&gt;pattern_end==<span class="literal">false</span>);</span><br><span class="line">        parent_node-&gt;pattern_end = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TrieNode* <span class="title">list_search</span><span class="params">(TrieNode* list_head, <span class="keyword">char</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(list_head &amp;&amp; list_head-&gt;this_char!=target)</span><br><span class="line">        list_head = list_head-&gt;sibling;</span><br><span class="line">    <span class="keyword">return</span> list_head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_longest_trans_target</span><span class="params">(TrieNode* root)</span> </span>&#123;</span><br><span class="line">    assert(root!=<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;TrieNode*&gt; <span class="built_in">stack</span>;</span><br><span class="line">    TrieNode* current = root;</span><br><span class="line">    <span class="keyword">while</span>(current) &#123;</span><br><span class="line">        <span class="built_in">stack</span>.push_back(current);</span><br><span class="line">        current = current-&gt;sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// bfs可以正确传递pattern_end标志, 但是需要使用queue实现。</span></span><br><span class="line">    <span class="comment">// 此处dfs。</span></span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">stack</span>.empty())&#123;</span><br><span class="line">        current = <span class="built_in">stack</span>.back();</span><br><span class="line">        <span class="built_in">stack</span>.pop_back();</span><br><span class="line">        TrieNode* children = current-&gt;children;</span><br><span class="line">        <span class="keyword">while</span>(children) &#123;</span><br><span class="line">            TrieNode* candidate = current-&gt;prefix;</span><br><span class="line">            <span class="keyword">while</span>(candidate &amp;&amp; children-&gt;prefix==<span class="literal">nullptr</span>) &#123;</span><br><span class="line">                children-&gt;prefix = list_search(candidate-&gt;children, children-&gt;this_char);</span><br><span class="line">                candidate = candidate-&gt;prefix;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(children-&gt;prefix==<span class="literal">nullptr</span>)</span><br><span class="line">                children-&gt;prefix = list_search(root, children-&gt;this_char);</span><br><span class="line">            assert(children-&gt;prefix!=children);</span><br><span class="line">            <span class="built_in">stack</span>.push_back(children);</span><br><span class="line">            TrieNode* prefix = children-&gt;prefix;</span><br><span class="line">            <span class="keyword">bool</span> pattern_end = children-&gt;pattern_end;</span><br><span class="line">            <span class="keyword">while</span>(prefix &amp;&amp; !pattern_end) &#123;</span><br><span class="line">                pattern_end = pattern_end || prefix-&gt;pattern_end;</span><br><span class="line">                prefix = prefix-&gt;prefix;</span><br><span class="line">            &#125;</span><br><span class="line">            children-&gt;pattern_end = pattern_end;</span><br><span class="line">            children = children-&gt;sibling;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_tree</span><span class="params">(TrieNode* root, <span class="keyword">bool</span> newline=<span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(root) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"("</span> &lt;&lt; root-&gt;this_char &lt;&lt; <span class="string">","</span> &lt;&lt; root-&gt;height &lt;&lt; <span class="string">","</span> </span><br><span class="line">            &lt;&lt; root-&gt;pattern_end &lt;&lt; <span class="string">") "</span>;</span><br><span class="line">        print_tree(root-&gt;children, <span class="literal">false</span>);</span><br><span class="line">        root = root-&gt;sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(newline) <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ac-search-amp-test"><a href="#ac-search-amp-test" class="headerlink" title="ac-search &amp; test"></a>ac-search &amp; test</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fill_pattern_occurrence</span><span class="params">(TrieNode* suffix, <span class="keyword">const</span> <span class="built_in">string</span>&amp; haystack, <span class="keyword">int</span> pos, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="built_in">vector</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt;&amp; result)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=pos; i&gt;=<span class="number">0</span> &amp;&amp; suffix; --i) &#123;</span><br><span class="line">        <span class="keyword">char</span> curr_char = haystack[i];</span><br><span class="line">        suffix = list_search(suffix, curr_char);</span><br><span class="line">        <span class="keyword">if</span>(suffix-&gt;pattern_end) &#123;</span><br><span class="line">            <span class="comment">// [i, pos+1) ~ [i, pos]</span></span><br><span class="line">            result.push_back(make_pair(i, pos+<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        suffix = suffix-&gt;children;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [begin_pos, end_pos)</span></span><br><span class="line"><span class="built_in">vector</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; ac_search(TrieNode* root, TrieNode* suffix, <span class="keyword">const</span> <span class="built_in">string</span>&amp; haystack) &#123;</span><br><span class="line">    assert(root!=<span class="literal">nullptr</span>);</span><br><span class="line">    assert(suffix!=<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt; result;</span><br><span class="line">    TrieNode* prev_matched = <span class="literal">nullptr</span>;</span><br><span class="line">    TrieNode* curr_matched = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;haystack.size(); ++i) &#123;</span><br><span class="line">        <span class="keyword">char</span> curr_char = haystack[i];</span><br><span class="line">        <span class="keyword">while</span>(prev_matched &amp;&amp; !curr_matched) &#123;</span><br><span class="line">            curr_matched = list_search(prev_matched-&gt;children, curr_char);</span><br><span class="line">            prev_matched = prev_matched-&gt;prefix;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(curr_matched==<span class="literal">nullptr</span>)</span><br><span class="line">            curr_matched = list_search(root, curr_char);</span><br><span class="line">        <span class="keyword">if</span>(curr_matched &amp;&amp; curr_matched-&gt;pattern_end) &#123;</span><br><span class="line">            fill_pattern_occurrence(suffix, haystack, i, result);</span><br><span class="line">        &#125;</span><br><span class="line">        prev_matched = curr_matched;</span><br><span class="line">        curr_matched = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; patterns = &#123;</span><br><span class="line">        <span class="string">"announce"</span>,</span><br><span class="line">        <span class="string">"annual"</span>,</span><br><span class="line">        <span class="string">"annually"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">string</span> haystack = <span class="string">"annual_announce"</span>;</span><br><span class="line"></span><br><span class="line">    TrieNode* prefix = build_trie(patterns);</span><br><span class="line">    build_longest_trans_target(prefix);</span><br><span class="line">    TrieNode* suffix = build_suffix(patterns);</span><br><span class="line"></span><br><span class="line">    print_tree(prefix);</span><br><span class="line">    print_tree(suffix);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> result = ac_search(prefix, suffix, haystack);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; item : result) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; item.first &lt;&lt; <span class="string">", "</span> &lt;&lt; item.second &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    free_trie(prefix);</span><br><span class="line">    free_trie(suffix);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码：<a href="https://github.com/kmiku7/algorithms/blob/master/basic_ac_algorithm/main.cpp" target="_blank" rel="noopener">github</a></p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2015/04/25/basic-aho-corasick-algorithm/" data-id="cjonvdpbf000a6wfyhdw4wipk" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2015/04/25/basic-aho-corasick-algorithm/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ac-search/">ac-search</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cpp/">cpp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-structure/">data-structure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/string-match/">string-match</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tree/">tree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trie/">trie</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zh/">zh</a></li></ul>

    </footer>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenTSDB/">OpenTSDB</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cpp/">cpp</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/interview/">interview</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ros/">ros</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bugfix/">Bugfix</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DATABASE/">DATABASE</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Django/">Django</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NoSQL/">NoSQL</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenTSDB/">OpenTSDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ac-search/">ac-search</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/avl-tree/">avl-tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/b-tree/">b-tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clrs/">clrs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-analysis/">code-analysis</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/codis/">codis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpp/">cpp</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/data-structure/">data-structure</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/en/">en</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gorun/">gorun</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libchan/">libchan</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/list/">list</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logging/">logging</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/merge-sort/">merge-sort</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/morris-travesal/">morris-travesal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy/">proxy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ros/">ros</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ros1/">ros1</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rosconsole/">rosconsole</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/roscore/">roscore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/roslaunch/">roslaunch</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rosout/">rosout</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/">sort</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/string-match/">string-match</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread/">thread</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/threaded-binary-tree/">threaded-binary-tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/threading/">threading</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tree/">tree</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/trie/">trie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uWSGI/">uWSGI</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zh/">zh</a><span class="tag-list-count">11</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Bugfix/" style="font-size: 13.33px;">Bugfix</a> <a href="/tags/DATABASE/" style="font-size: 13.33px;">DATABASE</a> <a href="/tags/Django/" style="font-size: 11.67px;">Django</a> <a href="/tags/HBase/" style="font-size: 13.33px;">HBase</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/NoSQL/" style="font-size: 13.33px;">NoSQL</a> <a href="/tags/OpenTSDB/" style="font-size: 13.33px;">OpenTSDB</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/ac-search/" style="font-size: 10px;">ac-search</a> <a href="/tags/algorithm/" style="font-size: 13.33px;">algorithm</a> <a href="/tags/avl-tree/" style="font-size: 10px;">avl-tree</a> <a href="/tags/b-tree/" style="font-size: 10px;">b-tree</a> <a href="/tags/clrs/" style="font-size: 10px;">clrs</a> <a href="/tags/code-analysis/" style="font-size: 18.33px;">code-analysis</a> <a href="/tags/codis/" style="font-size: 10px;">codis</a> <a href="/tags/cpp/" style="font-size: 16.67px;">cpp</a> <a href="/tags/data-structure/" style="font-size: 13.33px;">data-structure</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/en/" style="font-size: 10px;">en</a> <a href="/tags/golang/" style="font-size: 13.33px;">golang</a> <a href="/tags/gorun/" style="font-size: 10px;">gorun</a> <a href="/tags/leetcode/" style="font-size: 13.33px;">leetcode</a> <a href="/tags/libchan/" style="font-size: 10px;">libchan</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/logging/" style="font-size: 10px;">logging</a> <a href="/tags/merge-sort/" style="font-size: 10px;">merge-sort</a> <a href="/tags/morris-travesal/" style="font-size: 10px;">morris-travesal</a> <a href="/tags/proxy/" style="font-size: 10px;">proxy</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/ros/" style="font-size: 13.33px;">ros</a> <a href="/tags/ros1/" style="font-size: 13.33px;">ros1</a> <a href="/tags/rosconsole/" style="font-size: 10px;">rosconsole</a> <a href="/tags/roscore/" style="font-size: 13.33px;">roscore</a> <a href="/tags/roslaunch/" style="font-size: 11.67px;">roslaunch</a> <a href="/tags/rosout/" style="font-size: 10px;">rosout</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/stl/" style="font-size: 10px;">stl</a> <a href="/tags/string-match/" style="font-size: 10px;">string-match</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/threaded-binary-tree/" style="font-size: 10px;">threaded-binary-tree</a> <a href="/tags/threading/" style="font-size: 10px;">threading</a> <a href="/tags/tree/" style="font-size: 13.33px;">tree</a> <a href="/tags/trie/" style="font-size: 10px;">trie</a> <a href="/tags/uWSGI/" style="font-size: 11.67px;">uWSGI</a> <a href="/tags/zh/" style="font-size: 20px;">zh</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/16/Why-uploading-large-file-using-Requests-is-very-slow/">Why uploading large file using Requests is very slow?</a>
          </li>
        
          <li>
            <a href="/2018/11/07/upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly/">Upgrading To A New Nginx Binary In Different Place On The Fly</a>
          </li>
        
          <li>
            <a href="/2018/03/27/OpenTSDB-Code-Reading-4-Query-Command/">OpenTSDB Code Reading: 4. Query Command</a>
          </li>
        
          <li>
            <a href="/2018/03/23/OpenTSDB-Code-Reading-3-Commands/">OpenTSDB Code Reading: 3. Commands</a>
          </li>
        
          <li>
            <a href="/2018/03/23/OpenTSDB-Code-Reading-2-Server-Framework/">OpenTSDB Code Reading: 2. Server Framework</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 kmiku7<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="https://github.com/kmiku7/landscape-k" target="_blank">landscape-k</a>.
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'kmiku7';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>