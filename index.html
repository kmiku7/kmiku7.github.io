<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kmiku7&#39;s blog</title>
  
    <meta name="robots" content="noindex, follow">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="kmiku7&#39;s blog">
<meta property="og:url" content="http://kmiku7.github.io/index.html">
<meta property="og:site_name" content="kmiku7&#39;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kmiku7&#39;s blog">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  <!--link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"-->
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-27155459-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">kmiku7&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">JUST DO IT.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://kmiku7.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Why-uploading-large-file-using-Requests-is-very-slow" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/16/Why-uploading-large-file-using-Requests-is-very-slow/" class="article-date">
  <time datetime="2018-11-16T09:39:24.657Z" itemprop="datePublished">Nov 16 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/16/Why-uploading-large-file-using-Requests-is-very-slow/">Why uploading large file using Requests is very slow?</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I write a python script to upload files with Requests Lib. The script need about 7 miniutes to upload a file about 3GB in size. While the curl only take less than a miniute.<br>According server-side&#39;s logs, the time usage between server accept socket and close it is less than a miniute when we use python script.</p>
<p><strong>Where is the Requests library spend its time?</strong></p>
<p>After reading Requests&#39;s code, I find the lib will read the full content into memory and encode using the multipart/form-data mime format.<br>The function <a href="https://github.com/requests/requests/blob/v2.20.1/requests/models.py#L110" target="_blank" rel="noopener">_encode_files</a> is used to process file upload request. In the <a href="https://github.com/requests/requests/blob/v2.20.1/requests/models.py#L159" target="_blank" rel="noopener">line:159</a> it read the full content of file. And then call encode_multipart_formdata() function to encode data in the line:169.<br>After this, the libaray can calculate the content length in request body and add &#39;Content-Length&#39; header.</p>
<p><strong>Why is curl upload file so fast?</strong><br>Because http client need send &#39;Content-Length&#39; header before send body. So we need calculate body size at first. When we upload file, loading file content into memory and encoding body and then calculating body size is a trivial solution.</p>
<p>So is the time usage difference caused by the performace difference between python and c++?</p>
<p>After reading curl&#39;s code, I find the programming language performance difference is not the only reason.</p>
<p>When curl build request to upload file, it will build mimepart structure to describe such a file. When send http body, the curl will call structure method to read data. The related code is <a href="https://github.com/curl/curl/blob/master/lib/mime.c#L1346" target="_blank" rel="noopener">here</a>.</p>
<p>When we cacluate the body size before send body content, we only need file size. The length of encoded content is unrelated to file content. The related code is <a href="https://github.com/curl/curl/blob/master/lib/mime.c#L1587" target="_blank" rel="noopener">here</a>.</p>
<p>At last, I use pycurl to refactor my script and the cript perforamce is same as the command curl.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li><a href="http://docs.python-requests.org/en/master/" target="_blank" rel="noopener">Requests</a></li>
<li><a href="https://curl.haxx.se/" target="_blank" rel="noopener">Curl</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/11/16/Why-uploading-large-file-using-Requests-is-very-slow/" data-id="cjojyivdu000463s6418jaiwb" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/11/16/Why-uploading-large-file-using-Requests-is-very-slow/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/07/upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly/" class="article-date">
  <time datetime="2018-11-07T05:04:56.987Z" itemprop="datePublished">Nov 7 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/07/upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly/">Upgrading To A New Nginx Binary In Different Place On The Fly</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently we need use some features which provided by the new Nginx release. And the current package is provided by the company&#39;s system team and they don&#39;t provide a new version package. So we need build it by ourselves.</p>
<p>Because the orignal package is installed by yum and we want to deploy new package by different method, so putting the new package in different place maybe better. So we face such a problem:</p>
<blockquote>
<p>We want to upgrade Nginx to a new version, and the new version binary and all its dependency is put in different place. In the same time, the server must provide serivce continous without downtime.</p>
</blockquote>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-upgrade-nginx-in-place-without-dropping-client-connections" target="_blank" rel="noopener">How To Upgrade Nginx In-Place Without Dropping Client Connections</a> talks about upgrading nginx in-place.</p>
<p>Nginx release 1.9.1 introduces a new feature that enables use of SO_REUSEPORT. With this we can complete the task.</p>
<h2 id="Operation-Steps"><a href="#Operation-Steps" class="headerlink" title="Operation Steps"></a>Operation Steps</h2><p>First we compile new Nginx release and set absolute path for <code>--prefix</code> etc. Deploy the output on the machine. Enables <code>reuseport</code> directive for new packages.</p>
<p>Copy <code>&lt;NEW_PACKAGE&gt;/sbin/nginx</code> to <code>&lt;OLD_PACKAGE&gt;/sbin/nginx</code>, and upgrade Nginx with the new <code>&lt;OLD_PACKAGE&gt;/sbin/nginx</code> binary using the methods from <a href="https://www.digitalocean.com/community/tutorials/how-to-upgrade-nginx-in-place-without-dropping-client-connections" target="_blank" rel="noopener">How To Upgrade Nginx In-Place Without Dropping Client Connections</a>.</p>
<p>Start another Nginx master using <code>&lt;NEW_PACKAGE&gt;/sbin/nginx</code>. Because <code>reuseport</code> enabled, we can start two masters by hand. And then stop master launched by <code>&lt;OLD_PACKAGE&gt;/sbin/nginx</code> gracefully. After &#39;old&#39; nginx master stopped, <code>&lt;NEW_PACKAGE&gt;/run/nginx.pid</code> maybe deleted, because we have two masters write its process id into same file. We just generate this file for the last master by hand.</p>
<p>Remove <code>reuseport</code> directive in configure file, and then reload Nginx.</p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/11/07/upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly/" data-id="cjojyivgx005163s6ajp3wdgm" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/11/07/upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-OpenTSDB-Code-Reading-4-Query-Command" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/27/OpenTSDB-Code-Reading-4-Query-Command/" class="article-date">
  <time datetime="2018-03-27T08:36:16.193Z" itemprop="datePublished">Mar 27 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/OpenTSDB/">OpenTSDB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/27/OpenTSDB-Code-Reading-4-Query-Command/">OpenTSDB Code Reading: 4. Query Command</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>http-api: api/query<br>code: class net.opentsdb.tsd.QueryRpc<br>document: <a href="http://opentsdb.net/docs/build/html/api_http/query/index.html" target="_blank" rel="noopener">HTTP API, Query</a></p>
<p><strong>查询DEMO</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/api/query?start=2018/03/27-16:30:02&amp;m=sum:proc.net.bytes</span><br><span class="line"></span><br><span class="line">/api/query?start=2018/03/27-16:20:02&amp;m=sum:proc.net.bytes&#123;direction=in&#125;</span><br><span class="line"></span><br><span class="line">/api/query?start=2018/03/27-16:20:02&amp;m=none:1m-avg-none:proc.net.bytes&#123;direction=in&#125;</span><br><span class="line"></span><br><span class="line">/api/query?start=2018/03/27-16:30:02&amp;tsuid=sum:00015D00000100000100000A00007F00000B000081,00015D00000100000100000A00007F00000B000080</span><br></pre></td></tr></table></figure></p>
<h2 id="解析请求"><a href="#解析请求" class="headerlink" title="解析请求"></a>解析请求</h2><p>解析请求参数，构造、填充到 <code>net.opentsdb.core.TSQuery</code> 对象中。<br>其中Metric &amp; TSUID参数的核心解析代码位于:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.opentsdb.tsd.QueryRpc::parseMTypeSubQuery</span><br><span class="line">net.opentsdb.tsd.QueryRpc::parseTsuidTypeSubQuery</span><br></pre></td></tr></table></figure></p>
<p>涉及的类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 对应额一次 http/telnet 请求</span><br><span class="line">net.opentsdb.core.TSQuery</span><br><span class="line"></span><br><span class="line">// 对应一次请求中的一个 query</span><br><span class="line">net.opentsdb.core.TSSubQuery</span><br><span class="line"></span><br><span class="line">// A query to retrieve data from the TSDB.</span><br><span class="line">// interface</span><br><span class="line">net.opentsdb.core.Query</span><br><span class="line"></span><br><span class="line">// Non-synchronized implementation of interface Query.</span><br><span class="line">// 与 TSSubQuery 一一对应</span><br><span class="line">net.opentsdb.core.TsdbQuery</span><br><span class="line"></span><br><span class="line">// </span><br><span class="line">net.opentsdb.query.filter.TagVFilter</span><br></pre></td></tr></table></figure></p>
<p>每个query真正执行入口位于:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.opentsdb.core.TsdbQuery::runAsync()</span><br></pre></td></tr></table></figure></p>
<p>OpenTSDB 通过 scanner 过滤 time-range, metric, tagKV 筛选符合要求的数据，然后在本地再进行 aggregate, downsampling。</p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/03/27/OpenTSDB-Code-Reading-4-Query-Command/" data-id="cjojyivgc004k63s6f1k0e2ft" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/03/27/OpenTSDB-Code-Reading-4-Query-Command/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-OpenTSDB-Code-Reading-3-Commands" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/23/OpenTSDB-Code-Reading-3-Commands/" class="article-date">
  <time datetime="2018-03-23T11:44:49.000Z" itemprop="datePublished">Mar 23 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/OpenTSDB/">OpenTSDB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/23/OpenTSDB-Code-Reading-3-Commands/">OpenTSDB Code Reading: 3. Commands</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Class: net.opentsdb.tsd.RpcManager</p>
<p>该类维护了HTTP/RPC Protocol下指令，以及具体执行对象的信息。</p>
<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><h3 id="Write"><a href="#Write" class="headerlink" title="Write"></a>Write</h3><h4 id="put"><a href="#put" class="headerlink" title="put"></a>put</h4><p>telnet: put<br>http-api: api/put<br>code: class PutDataPointRpc</p>
<h5 id="qualifier-格式"><a href="#qualifier-格式" class="headerlink" title="qualifier 格式"></a>qualifier 格式</h5><p>Long比特位格式：<br>bit[0:2] 保存value length<br>bit[3] Float Flag<br><strong>毫秒时间戳</strong><br>bit[0:5] 保存flag<br>bit[6:27] 保存真实时间戳<br>bit[28:31] 全为1，java为大端，该信息保存在bytes[0]位置<br><strong>秒时间戳</strong><br>bit[0:3] 保存flag<br>bit[4:] 保存真实时间戳</p>
<h5 id="秒与毫秒时间戳的区分"><a href="#秒与毫秒时间戳的区分" class="headerlink" title="秒与毫秒时间戳的区分"></a>秒与毫秒时间戳的区分</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Mask to verify a timestamp on 4 bytes in seconds */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SECOND_MASK = <span class="number">0xFFFFFFFF00000000L</span>;</span><br></pre></td></tr></table></figure>
<p>timestamp不超过<code>~SECOND_MASK</code>，则认为时间戳单位为秒。否则为毫秒。<br>参考代码：<a href="https://github.com/kmiku7/opentsdb/blob/comment-v2.3.0/src/core/TSDB.java#L967" target="_blank" rel="noopener">link</a></p>
<h5 id="append模式与普通模式"><a href="#append模式与普通模式" class="headerlink" title="append模式与普通模式"></a>append模式与普通模式</h5><p>append模式下，统一小时内的数据都追加到同一列中，qualifer为<code>0x050000</code>，共三字节。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: AppendDataPoints.java</span></span><br><span class="line"><span class="comment">// Line: 41</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppendDataPoints</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(AppendDataPoints.class);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** The prefix ID of append columns */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> APPEND_COLUMN_PREFIX = <span class="number">0x05</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** The full column qualifier for append columns */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] APPEND_COLUMN_QUALIFIER = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123;</span><br><span class="line">    APPEND_COLUMN_PREFIX, <span class="number">0x00</span>, <span class="number">0x00</span>&#125;;</span><br></pre></td></tr></table></figure></p>
<p>References:</p>
<ul>
<li><a href="http://opentsdb.net/docs/build/html/user_guide/writing.html#appends" target="_blank" rel="noopener">OpenTSDB, User Guide, Writing Data, Appends</a></li>
</ul>
<h5 id="compaction"><a href="#compaction" class="headerlink" title="compaction"></a>compaction</h5><p>class: </p>
<ul>
<li>net.opentsdb.core.CompactionQueue</li>
<li>net.opentsdb.core.CompactionQueue.Compaction</li>
<li>net.opentsdb.core.CompactionQueue.ColumnDatapointIterator</li>
</ul>
<p>非append模式下，每次有新数据写入，就会将rowkey插入到一个CompactionQueue，然后定期处理，该对象是一个Sorted Set，插入时有去重。</p>
<p>CompactionQueue初始化时会启动一个thread处理任务。当前时间 - baseTime(rowkey) &gt; 3600秒，则会进行处理。</p>
<h3 id="Read"><a href="#Read" class="headerlink" title="Read"></a>Read</h3><h4 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h4><p>telnet: stats<br>http-api: api/stats<br>http-ui: stats<br>code: class StatsRpc</p>
<p>class: net.opentsdb.stats.StatsCollector<br>StatsCollector是一个抽象基类，接口实现中初始化一个StatsCollector类型对象，然后在各组件中通过调用collectStats()接口收集状态信息。<br>StatsCollector默认内部记录统计信息的格式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats-name timestamp value tagk=tagv tagk=tav...</span><br></pre></td></tr></table></figure></p>
<p>返回给用户的，没记录一条信息就会调用StatsCollector::emit(record-str)函数，子类实现emit函数，完成格式的状态。</p>
<h4 id="Drop-Caches"><a href="#Drop-Caches" class="headerlink" title="Drop Caches"></a>Drop Caches</h4><p>telnet: dropcaches<br>http-api: api/dropcaches<br>http-ui: dropcaches<br>code: class DropCachesRpc</p>
<p>metrics/tagk/tagv各对应一个UniqueId Instance，该类内部有 name &lt;-&gt; id 映射关系的缓存，该接口清空这三个对象内部缓存。<a href="https://github.com/kmiku7/opentsdb/blob/comment-v2.3.0/src/core/TSDB.java#L1276" target="_blank" rel="noopener">code link</a></p>
<h4 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h4><p>telnet: version<br>http-api: api/version<br>http-ui: version<br>code: class RpcManager.Version</p>
<p>获取实例的版本信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;short_revision&quot;: &quot;&quot;,</span><br><span class="line">    &quot;repo&quot;: &quot;/root/opentsdb-2.3.0/build&quot;,</span><br><span class="line">    &quot;host&quot;: &quot;***********&quot;,</span><br><span class="line">    &quot;version&quot;: &quot;2.3.0&quot;,</span><br><span class="line">    &quot;full_revision&quot;: &quot;&quot;,</span><br><span class="line">    &quot;repo_status&quot;: &quot;MODIFIED&quot;,</span><br><span class="line">    &quot;user&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;branch&quot;: &quot;&quot;,</span><br><span class="line">    &quot;timestamp&quot;: &quot;1521782831&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过脚本<code>build-aux/gen_build_data.sh</code>生成BuildData.java文件，运行时读取该类的信息。</p>
<h4 id="Exit"><a href="#Exit" class="headerlink" title="Exit"></a>Exit</h4><p>telnet: exit<br>code: class RpcManager.Exit</p>
<p>关闭连接。</p>
<h4 id="Help"><a href="#Help" class="headerlink" title="Help"></a>Help</h4><p>telnet: help<br>code: class RpcManager.Help</p>
<p>返回telnet_commands列表。</p>
<h4 id="HomePage"><a href="#HomePage" class="headerlink" title="HomePage"></a>HomePage</h4><p>http-ui: &quot;&quot;<br>code: class RpcManager.HomePage</p>
<p>UI主页。</p>
<h4 id="List-Aggregators"><a href="#List-Aggregators" class="headerlink" title="List Aggregators"></a>List Aggregators</h4><p>http-api: api/aggregators<br>http-ui: aggregators<br>code: class ListAggregators</p>
<p>显示支持的聚合方式列表。</p>
<h4 id="Static-File"><a href="#Static-File" class="headerlink" title="Static File"></a>Static File</h4><p>http-ui: favicon.ico|s<br>code: class StaticFileRpc</p>
<p>返回 /s/[path/to/static/file] s之后的uri部分对应的静态文件。</p>
<h4 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h4><p>http-ui: logs<br>code: class LogsRpc</p>
<p>该接口有两类功能：</p>
<ol>
<li>获取日志信息，默认plain text格式，可加参数json。</li>
<li>设置logger日志等级，参数 level, logger。<br><a href="https://logback.qos.ch/apidocs/src-html/ch/qos/logback/classic/Level.html#line.198" target="_blank" rel="noopener">level参数取值</a></li>
</ol>
<h4 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h4><p>http-ui: q<br>code: class GraphHandler</p>
<h4 id="Suggest"><a href="#Suggest" class="headerlink" title="Suggest"></a>Suggest</h4><p>http-api: api/suggest<br>http-ui: suggest<br>code: SuggestRpc</p>
<p>It&#39;s used for auto-complete entries and does not support wildcards.</p>
<p>输入参数：</p>
<ul>
<li>type: metrics, tagk, tagv. required.</li>
<li>q: optional, default &quot;&quot;.</li>
<li>max: optional, default 25.</li>
</ul>
<h4 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h4><p>http-api: api/annotation|api/annotations<br>code: class AnnotationRpc</p>
<h4 id="Show-Config"><a href="#Show-Config" class="headerlink" title="Show Config"></a>Show Config</h4><p>http-api: api/config<br>code: class RpcManager.ShowConfig</p>
<p>两种请求</p>
<ol>
<li>api/config<br>返回运行实例的配置项。</li>
<li>api/config/filters<br>返回所有的tag value filters信息。</li>
</ol>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><p>http-api: api/query<br>code: class QueryRpc</p>
<p>Reference:</p>
<ul>
<li><a href="http://opentsdb.net/docs/build/html/api_http/query/index.html" target="_blank" rel="noopener">HTTP API, /api/query</a></li>
</ul>
<h4 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h4><p>http-api: api/search<br>code: class SearchRpc</p>
<p>Reference:</p>
<ul>
<li><a href="http://opentsdb.net/docs/build/html/api_http/search/index.html" target="_blank" rel="noopener">HTTP API, /api/search</a></li>
</ul>
<h4 id="Serializers"><a href="#Serializers" class="headerlink" title="Serializers"></a>Serializers</h4><p>http-api: api/serializers<br>code: class Serializers</p>
<p>显示支持的序列化方式列表。</p>
<h4 id="Tree"><a href="#Tree" class="headerlink" title="Tree"></a>Tree</h4><p>http-api: api/tree<br>code: class TreeRpc</p>
<p>Reference:</p>
<ul>
<li><a href="http://opentsdb.net/docs/build/html/user_guide/trees.html" target="_blank" rel="noopener">User Guide, Trees</a></li>
</ul>
<ol>
<li>/api/tree</li>
<li>/api/tree/branch</li>
<li>/api/tree/rule</li>
<li>/api/tree/rules</li>
<li>/api/tree/test</li>
<li>/api/tree/collisions</li>
<li>/api/tree/notmatched</li>
</ol>
<h4 id="UniqueId"><a href="#UniqueId" class="headerlink" title="UniqueId"></a>UniqueId</h4><p>http-api: api/uid<br>code: class UniqueIdRpc</p>
<p>该接口有如下子功能：</p>
<ol>
<li><p>assign<br>给name分配uid。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/uid/assign?metric=nameA,nameB&amp;tagk=nameC,nameD&amp;tagv=nameE,nameF</span><br></pre></td></tr></table></figure>
</li>
<li><p>uidmeta<br> 2.1. GET<br> 获取uid meta信息</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/uid/uidmeta?type=tagk&amp;uid=000013</span><br></pre></td></tr></table></figure>
<p> 2.2. POST<br> 设置meta信息。<br> 2.3. DELETE<br> 删除meta信息。</p>
</li>
<li>tsmeta<br>Handles CRUD calls to individual TSMeta data entries</li>
<li>rename<br>更改uid对应的名字，一次只能更新一个。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/uid/rename?tagk=OldName&amp;name=NewName</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="DieDieDie"><a href="#DieDieDie" class="headerlink" title="DieDieDie"></a>DieDieDie</h4><p>telnet: diediedie<br>http: diediedie<br>code: class DieDieDie</p>
<p>关闭服务端。</p>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/03/23/OpenTSDB-Code-Reading-3-Commands/" data-id="cjojyivdw000563s6op9qijm8" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/03/23/OpenTSDB-Code-Reading-3-Commands/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DATABASE/">DATABASE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HBase/">HBase</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NoSQL/">NoSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenTSDB/">OpenTSDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-analysis/">code-analysis</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-OpenTSDB-Code-Reading-2-Server-Framework" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/23/OpenTSDB-Code-Reading-2-Server-Framework/" class="article-date">
  <time datetime="2018-03-23T09:54:56.000Z" itemprop="datePublished">Mar 23 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/OpenTSDB/">OpenTSDB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/23/OpenTSDB-Code-Reading-2-Server-Framework/">OpenTSDB Code Reading: 2. Server Framework</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>入口: net.opentsdb.tools.TSDMain</p>
<h2 id="Startup-Plugin"><a href="#Startup-Plugin" class="headerlink" title="Startup Plugin"></a>Startup Plugin</h2><p>代码文件 net.opentsdb.tools StartupPlugin.java</p>
<p>用途：</p>
<blockquote>
<p>The StartupPlugin allows users to interact with the OpenTSDB configuration as soon as it is completely parsed, just before OpenTSDB begins to use it.<br>服务初始化时，准备提供服务时，退出时，会调用plugin接口。代码中没有提供已实现的Startup Plugin。</p>
</blockquote>
<p>配置项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tsd.startup.enable</span><br><span class="line">tsd.core.plugin_path</span><br><span class="line">tsd.startup.plugin</span><br></pre></td></tr></table></figure></p>
<p>Reference:</p>
<ul>
<li><a href="http://opentsdb.net/docs/build/html/user_guide/plugins.html#startup-and-service-discovery" target="_blank" rel="noopener">Plugins, Startup and Service Discovery</a><br>文档提到的两个plugin demo链接已经失效，可用链接如下，但是demo几乎没什么用。<ol>
<li><a href="https://www.programcreek.com/java-api-examples/?code=inst-tech/opentsdb-plugins/opentsdb-plugins-master/src/main/java/io/tsdb/opentsdb/discovery/IdentityPlugin.java" target="_blank" rel="noopener">Identity Plugin</a></li>
<li><a href="https://www.programcreek.com/java-api-examples/?code=inst-tech/opentsdb-plugins/opentsdb-plugins-master/src/main/java/io/tsdb/opentsdb/discovery/CuratorPlugin.java#" target="_blank" rel="noopener">Curator Plugin</a></li>
</ol>
</li>
</ul>
<h2 id="Server-Framework"><a href="#Server-Framework" class="headerlink" title="Server Framework"></a>Server Framework</h2><p>服务使用Netty实现，其Channel Pipeline的框架实现在<code>net.opentsdb.tsd PipelineFactory.java</code>。</p>
<p>根据文档，服务支持两类接口HTTP &amp; RPC，二者使用同一端口，区分方式是根据请求数据的第一个字节，如果第一个字节是[&#39;A&#39;, &#39;Z&#39;]之间的字符，则认为是一个HTTP方式的请求，否则是RPC请求。参考代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: PipelineFactory.java</span></span><br><span class="line"><span class="comment">// Line: 132</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Dynamically changes the &#123;<span class="doctag">@link</span> ChannelPipeline&#125; based on the request.</span></span><br><span class="line"><span class="comment">   * If a request uses HTTP, then this changes the pipeline to process HTTP.</span></span><br><span class="line"><span class="comment">   * Otherwise, the pipeline is changed to processes an RPC.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DetectHttpOrRpc</span> <span class="keyword">extends</span> <span class="title">FrameDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">decode</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">final</span> Channel chan,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">final</span> ChannelBuffer buffer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (buffer.readableBytes() &lt; <span class="number">1</span>) &#123;  <span class="comment">// Yes sometimes we can be called</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;                     <span class="comment">// with an empty buffer...</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> firstbyte = buffer.getUnsignedByte(buffer.readerIndex());</span><br><span class="line">      <span class="keyword">final</span> ChannelPipeline pipeline = ctx.getPipeline();</span><br><span class="line">      <span class="comment">// None of the commands in the RPC protocol start with a capital ASCII</span></span><br><span class="line">      <span class="comment">// letter for the time being, and all HTTP commands do (GET, POST, etc.)</span></span><br><span class="line">      <span class="comment">// so use this as a cheap way to differentiate the two.</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">'A'</span> &lt;= firstbyte &amp;&amp; firstbyte &lt;= <span class="string">'Z'</span>) &#123;</span><br><span class="line">        pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> HttpRequestDecoder());</span><br><span class="line">        <span class="keyword">if</span> (tsdb.getConfig().enable_chunked_requests()) &#123;</span><br><span class="line">          pipeline.addLast(<span class="string">"aggregator"</span>, <span class="keyword">new</span> HttpChunkAggregator(</span><br><span class="line">              tsdb.getConfig().max_chunked_requests()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// allow client to encode the payload (ie : with gziped json)</span></span><br><span class="line">        pipeline.addLast(<span class="string">"inflater"</span>, <span class="keyword">new</span> HttpContentDecompressor());</span><br><span class="line">        pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> HttpResponseEncoder());</span><br><span class="line">        pipeline.addLast(<span class="string">"deflater"</span>, <span class="keyword">new</span> HttpContentCompressor());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pipeline.addLast(<span class="string">"framer"</span>, <span class="keyword">new</span> LineBasedFrameDecoder(<span class="number">1024</span>));</span><br><span class="line">        pipeline.addLast(<span class="string">"encoder"</span>, ENCODER);</span><br><span class="line">        pipeline.addLast(<span class="string">"decoder"</span>, DECODER);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      pipeline.addLast(<span class="string">"timeout"</span>, timeoutHandler);</span><br><span class="line">      pipeline.remove(<span class="keyword">this</span>);</span><br><span class="line">      pipeline.addLast(<span class="string">"handler"</span>, rpchandler);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Forward the buffer to the next handler.</span></span><br><span class="line">      <span class="keyword">return</span> buffer.readBytes(buffer.readableBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>根据上述代码，我们可以总结两种接口类型的处理Pipeline如下：</p>
<ul>
<li>HTTP Protocol<ol>
<li>connmgr</li>
<li>detect</li>
<li>decoder</li>
<li>aggregator(optional)</li>
<li>inflater</li>
<li>encoder</li>
<li>deflater</li>
<li>timeout</li>
<li>handler</li>
</ol>
</li>
<li>RPC Protocol<ol>
<li>connmgr</li>
<li>detect</li>
<li>framer</li>
<li>encoder</li>
<li>decoder</li>
<li>timeout</li>
<li>handler</li>
</ol>
</li>
</ul>
<h3 id="Handler-Task"><a href="#Handler-Task" class="headerlink" title="Handler Task"></a>Handler Task</h3><h4 id="HTTP-Protocol"><a href="#HTTP-Protocol" class="headerlink" title="HTTP Protocol"></a>HTTP Protocol</h4><h5 id="connmgr"><a href="#connmgr" class="headerlink" title="connmgr"></a>connmgr</h5><p>Class: net.opentsdb.tsd.ConnectionManager</p>
<p>Keeps track of all existing connections.<br>Limits the max connections established.</p>
<h5 id="detect"><a href="#detect" class="headerlink" title="detect"></a>detect</h5><p>File: PipelineFactory.java class DetectHttpOrRpc</p>
<p>根据请求数据判断协议类型，并添加后续的pipeline handler。</p>
<h5 id="decoder"><a href="#decoder" class="headerlink" title="decoder"></a>decoder</h5><p>Class: org.jboss.netty.handler.codec.http.HttpRequestDecoder</p>
<p>官方的请求解析类。</p>
<h5 id="aggregator"><a href="#aggregator" class="headerlink" title="aggregator"></a>aggregator</h5><p>Class: org.jboss.netty.handler.codec.http.HttpChunkAggregator</p>
<h5 id="inflater"><a href="#inflater" class="headerlink" title="inflater"></a>inflater</h5><p>Class: org.jboss.netty.handler.codec.http.HttpContentDecompressor</p>
<h5 id="encoder"><a href="#encoder" class="headerlink" title="encoder"></a>encoder</h5><p>Class: org.jboss.netty.handler.codec.http.HttpResponseEncoder</p>
<h5 id="deflater"><a href="#deflater" class="headerlink" title="deflater"></a>deflater</h5><p>Class: org.jboss.netty.handler.codec.http.HttpContentCompressor</p>
<h5 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h5><p>Class: org.jboss.netty.handler.timeout.IdleStateHandler</p>
<h5 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h5><p>Class: net.opentsdb.tsd.RpcHandler<br>因为 HTTP/RPC handler 不同，解析出来的message类型也不同，该类根据消息类型在<code>net.opentsdb.tsd.RpcManager</code>中查询对应的 RPC(Telnet)/HTTP 指令执行函数并执行。</p>
<p>RpcManager中对HTTP官方指令和插件指令各单独维护了一个Map<cmdname, executor=""><br>，二者请求的区别在于uri前缀，如果uri前缀为<code>plugin</code>，则认为是请求插件中提供的功能。然后在对应的Map中查询然后执行。每个Plugin对应一个uri(route)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 请求官方指令</span><br><span class="line">/api/put</span><br><span class="line"></span><br><span class="line"># 请求插件指令</span><br><span class="line">/plugin/plugin-path</span><br></pre></td></tr></table></figure></cmdname,></p>
<p>OpenTSDB还支持RPC Plugin，该插件的实现逻辑与HTTP Protocol不同，Plugin实现自己独立的服务框架，与主框架间仅仅是共享一个<code>net.opentsdb.core.TSDB</code>对象。参考RpcPlugin抽象基类定义：<a href="https://github.com/kmiku7/opentsdb/blob/comment-v2.3.0/src/tsd/RpcPlugin.java" target="_blank" rel="noopener">RpcPlugin.java</a>。</p>
<h4 id="RPC-Protocol"><a href="#RPC-Protocol" class="headerlink" title="RPC Protocol"></a>RPC Protocol</h4><p>与HTTP Protocol相同的handler此处就不再列出。</p>
<h5 id="framer"><a href="#framer" class="headerlink" title="framer"></a>framer</h5><p>Class: net.opentsdb.tsd.LineBasedFrameDecoder</p>
<p>Decodes telnet-style frames delimited by new-lines.</p>
<h5 id="encoder-1"><a href="#encoder-1" class="headerlink" title="encoder"></a>encoder</h5><p>Class: org.jboss.netty.handler.codec.string.StringEncoder</p>
<h5 id="decoder-1"><a href="#decoder-1" class="headerlink" title="decoder"></a>decoder</h5><p>Class: net.opentsdb.tsd.WordSplitter</p>
<p>Splits a ChannelBuffer in multiple space separated words.</p>
<p>References:</p>
<ul>
<li><a href="http://www.fanyeong.com/2016/10/29/netty%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" target="_blank" rel="noopener">netty简明教程</a></li>
<li><a href="https://netty.io/4.0/api/io/netty/channel/ChannelHandler.html" target="_blank" rel="noopener">Netty Interface ChannelHandler</a></li>
<li><a href="http://opentsdb.net/docs/build/html/user_guide/plugins.html#rpc" target="_blank" rel="noopener">OpenTSDB, Plugins, RPC</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <!--a data-url="http://kmiku7.github.io/2018/03/23/OpenTSDB-Code-Reading-2-Server-Framework/" data-id="cjojyivdg000063s63wu673s8" class="article-share-link">Share</a-->
      
        <a href="http://kmiku7.github.io/2018/03/23/OpenTSDB-Code-Reading-2-Server-Framework/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Bugfix/">Bugfix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DATABASE/">DATABASE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HBase/">HBase</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NoSQL/">NoSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenTSDB/">OpenTSDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-analysis/">code-analysis</a></li></ul>

    </footer>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenTSDB/">OpenTSDB</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cpp/">cpp</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/interview/">interview</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ros/">ros</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bugfix/">Bugfix</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DATABASE/">DATABASE</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Django/">Django</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NoSQL/">NoSQL</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenTSDB/">OpenTSDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ac-search/">ac-search</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/avl-tree/">avl-tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/b-tree/">b-tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clrs/">clrs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-analysis/">code-analysis</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/codis/">codis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpp/">cpp</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/data-structure/">data-structure</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/en/">en</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gorun/">gorun</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libchan/">libchan</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/list/">list</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logging/">logging</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/merge-sort/">merge-sort</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/morris-travesal/">morris-travesal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy/">proxy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ros/">ros</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ros1/">ros1</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rosconsole/">rosconsole</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/roscore/">roscore</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/roslaunch/">roslaunch</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rosout/">rosout</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/">sort</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl/">stl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/string-match/">string-match</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread/">thread</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/threaded-binary-tree/">threaded-binary-tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/threading/">threading</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tree/">tree</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/trie/">trie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uWSGI/">uWSGI</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zh/">zh</a><span class="tag-list-count">11</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Bugfix/" style="font-size: 11.67px;">Bugfix</a> <a href="/tags/DATABASE/" style="font-size: 13.33px;">DATABASE</a> <a href="/tags/Django/" style="font-size: 11.67px;">Django</a> <a href="/tags/HBase/" style="font-size: 13.33px;">HBase</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/NoSQL/" style="font-size: 13.33px;">NoSQL</a> <a href="/tags/OpenTSDB/" style="font-size: 13.33px;">OpenTSDB</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/ac-search/" style="font-size: 10px;">ac-search</a> <a href="/tags/algorithm/" style="font-size: 13.33px;">algorithm</a> <a href="/tags/avl-tree/" style="font-size: 10px;">avl-tree</a> <a href="/tags/b-tree/" style="font-size: 10px;">b-tree</a> <a href="/tags/clrs/" style="font-size: 10px;">clrs</a> <a href="/tags/code-analysis/" style="font-size: 18.33px;">code-analysis</a> <a href="/tags/codis/" style="font-size: 10px;">codis</a> <a href="/tags/cpp/" style="font-size: 16.67px;">cpp</a> <a href="/tags/data-structure/" style="font-size: 13.33px;">data-structure</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/en/" style="font-size: 10px;">en</a> <a href="/tags/golang/" style="font-size: 13.33px;">golang</a> <a href="/tags/gorun/" style="font-size: 10px;">gorun</a> <a href="/tags/leetcode/" style="font-size: 13.33px;">leetcode</a> <a href="/tags/libchan/" style="font-size: 10px;">libchan</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/logging/" style="font-size: 10px;">logging</a> <a href="/tags/merge-sort/" style="font-size: 10px;">merge-sort</a> <a href="/tags/morris-travesal/" style="font-size: 10px;">morris-travesal</a> <a href="/tags/proxy/" style="font-size: 10px;">proxy</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/ros/" style="font-size: 13.33px;">ros</a> <a href="/tags/ros1/" style="font-size: 13.33px;">ros1</a> <a href="/tags/rosconsole/" style="font-size: 10px;">rosconsole</a> <a href="/tags/roscore/" style="font-size: 13.33px;">roscore</a> <a href="/tags/roslaunch/" style="font-size: 11.67px;">roslaunch</a> <a href="/tags/rosout/" style="font-size: 10px;">rosout</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/stl/" style="font-size: 10px;">stl</a> <a href="/tags/string-match/" style="font-size: 10px;">string-match</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/threaded-binary-tree/" style="font-size: 10px;">threaded-binary-tree</a> <a href="/tags/threading/" style="font-size: 10px;">threading</a> <a href="/tags/tree/" style="font-size: 13.33px;">tree</a> <a href="/tags/trie/" style="font-size: 10px;">trie</a> <a href="/tags/uWSGI/" style="font-size: 11.67px;">uWSGI</a> <a href="/tags/zh/" style="font-size: 20px;">zh</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/16/Why-uploading-large-file-using-Requests-is-very-slow/">Why uploading large file using Requests is very slow?</a>
          </li>
        
          <li>
            <a href="/2018/11/07/upgrading-to-a-new-nginx-binary-in-different-place-on-the-fly/">Upgrading To A New Nginx Binary In Different Place On The Fly</a>
          </li>
        
          <li>
            <a href="/2018/03/27/OpenTSDB-Code-Reading-4-Query-Command/">OpenTSDB Code Reading: 4. Query Command</a>
          </li>
        
          <li>
            <a href="/2018/03/23/OpenTSDB-Code-Reading-3-Commands/">OpenTSDB Code Reading: 3. Commands</a>
          </li>
        
          <li>
            <a href="/2018/03/23/OpenTSDB-Code-Reading-2-Server-Framework/">OpenTSDB Code Reading: 2. Server Framework</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 kmiku7<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="https://github.com/kmiku7/landscape-k" target="_blank">landscape-k</a>.
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'kmiku7';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>